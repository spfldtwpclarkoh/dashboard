<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        /* Hide tab panels by default */
        .tab-panel {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen p-8">

    <div class="max-w-6xl mx-auto">
        <!-- *** UPDATED: Wrapper for title and refresh button *** -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-black text-gray-800">Dashboard Admin Console</h1>
            <!-- *** NEW: Manual Refresh Button *** -->
            <button id="manual-refresh-btn" class="inline-flex justify-center rounded-lg border border-transparent bg-green-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                Refresh Dashboard
            </button>
        </div>

        <!-- NEW: Navigation Toolbar -->
        <nav class="mb-6">
            <ul class="flex border-b border-gray-300">
                <li><button data-tab="weather" class="nav-tab py-2 px-4 font-medium">Weather Widget</button></li>
                <li><button data-tab="logo" class="nav-tab py-2 px-4 font-medium">Logo</button></li>
                <li><button data-tab="gslides" class="nav-tab py-2 px-4 font-medium">Google Slides</button></li>
                <!-- *** NEW: News Feed Tab *** -->
                <li><button data-tab="news" class="nav-tab py-2 px-4 font-medium">News Feed</button></li>
                <li><button data-tab="nws" class="nav-tab py-2 px-4 font-medium">NWS/IPAWS Alerts</button></li>
                <!-- *** NEW: Active911 Tab *** -->
                <li><button data-tab="active911" class="nav-tab py-2 px-4 font-medium">Active911</button></li>
                <li><button data-tab="slide-management" class="nav-tab py-2 px-4 font-medium">Slide Management</button></li>
            </ul>
        </nav>

        <!-- NEW: Tab Content Wrapper -->
        <div id="tab-content">

            <!-- Global Config Form (wraps first 4 tabs) -->
            <div id="config-container" class="bg-white p-6 rounded-lg shadow-md mb-8">
                
                <div id="config-loading-spinner" class="text-center p-8">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-600">Loading Settings...</p>
                </div>

                <form id="config-form" class="hidden">
                    
                    <!-- TAB 1: Weather -->
                    <div id="tab-weather" class="tab-panel">
                        <fieldset class="border-t border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Weather Widget</legend>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="weather_locationName" class="block text-sm font-medium text-gray-700">Location Name</label>
                                    <input type="text" id="weather_locationName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="weather_latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
                                    <input type="number" step="any" id="weather_latitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="weather_longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
                                    <input type="number" step="any" id="weather_longitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="weather_refreshIntervalMinutes" class="block text-sm font-medium text-gray-700">Refresh (minutes)</label>
                                    <input type="number" id="weather_refreshIntervalMinutes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- TAB 2: Logo -->
                    <div id="tab-logo" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Dashboard Logo</legend>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="imgbb_api_key" class="block text-sm font-medium text-gray-700">ImgBB API Key</label>
                                    <input type="text" id="imgbb_api_key" placeholder="Your ImgBB API Key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="logo_upload" class="block text-sm font-medium text-gray-700">Upload New Logo</label>
                                <input type="file" id="logo_upload" accept="image/png, image/jpeg, image/gif, image/svg+xml" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <button type="button" id="upload-logo-btn" class="mt-3 inline-flex justify-center rounded-lg border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">
                                    Upload to ImgBB & Save
                                </button>
                                <span id="upload-feedback" class="ml-4 text-gray-600"></span>
                            </div>
                            <div class="mt-4">
                                <p class="block text-sm font-medium text-gray-700">Current Logo Preview:</p>
                                <img id="logo-preview" src="https://placehold.co/200x100/f1f5f9/94a3b8?text=No+Logo+Set" alt="Current Logo Preview" class="mt-2 h-24 w-auto rounded bg-gray-50">
                                <input type="hidden" id="logo_url"> <!-- To store the URL for saving -->
                            </div>
                        </fieldset>
                    </div>

                    <!-- TAB 3: Google Slides -->
                    <div id="tab-gslides" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Google Slides</legend>
                            <div class="form-grid mt-4">
                                <div class="col-span-1 md:col-span-2">
                                    <label for="googleSlides_scriptUrl" class="block text-sm font-medium text-gray-700">Apps Script URL (for slide count)</label>
                                    <input type="url" id="googleSlides_scriptUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <label for="googleSlides_embedUrlBase" class="block text-sm font-medium text-gray-700">Slides Embed URL (Base)</label>
                                    <input type="url" id="googleSlides_embedUrlBase" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="googleSlides_delayPerSlideSeconds" class="block text-sm font-medium text-gray-700">Delay per Slide (sec)</label>
                                    <input type="number" id="googleSlides_delayPerSlideSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="googleSlides_refreshIntervalMinutes" class="block text-sm font-medium text-gray-700">Refresh Count (min)</label>
                                    <input type="number" id="googleSlides_refreshIntervalMinutes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- *** NEW: News Feed Tab Panel *** -->
                    <div id="tab-news" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Rolling News Feed</legend>
                            <p class="text-sm text-gray-600 mt-2">
                                Settings for the standalone news feed slide (`rolling_news.html`).
                                The Google Sheet URL is managed inside the file itself.
                            </p>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="newsFeed_secondsPerItem" class="block text-sm font-medium text-gray-700">Seconds Per Slide</label>
                                    <input type="number" id="newsFeed_secondsPerItem" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    
                    <!-- TAB 4: NWS/IPAWS -->
                    <div id="tab-nws" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">NWS/IPAWS Alerts</legend>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="nwsAlertZone" class="block text-sm font-medium text-gray-700">NWS Alert Zone (e.g., OHZ054)</label>
                                    <input type="text" id="nwsAlertZone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="nwsAlertRefreshSeconds" class="block text-sm font-medium text-gray-700">Alert Refresh (sec)</label>
                                    <input type="number" id="nwsAlertRefreshSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- NEW: Active911 Tab Panel -->
                    <div id="tab-active911" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Active911 Alerts</legend>
                            <p class="text-sm text-gray-600 mt-2">
                                Polls Active911 for new alerts for a specific department.
                            </p>
                            <div class="form-grid mt-4">
                                <div class="col-span-1 md:col-span-2">
                                    <label for="active911_apiToken" class="block text-sm font-medium text-gray-700">API Token</label>
                                    <input type="password" id="active911_apiToken" placeholder="Your Active911 API Token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="active911_departmentId" class="block text-sm font-medium text-gray-700">Department ID</label>
                                    <input type="number" id="active911_departmentId" placeholder="1234" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="active911_pollIntervalSeconds" class="block text-sm font-medium text-gray-700">Poll Interval (seconds)</label>
                                    <input type="number" id="active911_pollIntervalSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="active911_alertDurationSeconds" class="block text-sm font-medium text-gray-700">Alert Display (seconds)</label>
                                    <input type="number" id="active911_alertDurationSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- This save button applies to all config tabs -->
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Save Settings
                        </button>
                        <span id="save-feedback" class="ml-4 text-green-600 font-medium items-center hidden">Saved!</span>
                    </div>
                </form>
            </div>

            <!-- TAB 5: Slide Management -->
            <div id="tab-slide-management" class="tab-panel">
                <!-- Add New Slide Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-bold mb-4">Add New Slide</h2>
                    <form id="add-slide-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label for="slide-url" class="block text-sm font-medium text-gray-700">Slide URL (src)</label>
                            <!-- *** UPDATED: Changed type="url" to type="text" to allow relative paths *** -->
                            <input type="text" id="slide-url" placeholder="https://example.com or ./local/page.html" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div>
                            <label for="slide-title" class="block text-sm font-medium text-gray-700">Title (for iframe)</label>
                            <input type="text" id="slide-title" placeholder="My Slide Title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div>
                            <label for="slide-duration" class="block text-sm font-medium text-gray-700">Duration (seconds)</label>
                            <input type="number" id="slide-duration" value="20" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div>
                            <label for="slide-order" class="block text-sm font-medium text-gray-700">Order</label>
                            <input type="number" id="slide-order" value="10" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div class="md:col-span-3 flex justify-end">
                            <button type="submit" class="inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                Add Slide
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Current Slides List -->
                <div>
                    <h2 class="text-2xl font-bold mb-4">Current Slides</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Note: The 'Google Slides' entry is managed automatically by the dashboard and is not shown here.
                    </p>
                    <div id="loading-spinner" class="text-center">
                        <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-gray-600">Loading Slides...</p>
                    </div>
                    <div id="slides-list" class="space-y-4">
                        <!-- Slides will be injected here by JavaScript -->
                    </div>
                </div>
            </div> <!-- End #tab-slide-management -->

        </div> <!-- End #tab-content -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        // UPDATED: Added Storage imports
        // Firebase Storage imports removed
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        // ------------------------------
        // CONFIGURATION
        // ------------------------------
        // This is the ONLY config needed for the admin panel.
        const firebaseConfig = {
          apiKey: "AIzaSyCew0RUOwuFT-rplkh6h80UBnKPOfrn7qo",
          authDomain: "stfd-dashboard.firebaseapp.com",
          projectId: "stfd-dashboard",
          storageBucket: "stfd-dashboard.firebasestorage.app",
          messagingSenderId: "54058446605",
          appId: "1:54058446605:web:ec492afcb8620109628a44",
          measurementId: "G-4N22BEGSF7"
        };

        // ------------------------------
        // Firebase Initialization
        // ------------------------------
        let db;
        // let storage; // NEW: Storage instance
        let slidesCollection;
        let configDocRef; // NEW: Reference to the global config doc
        
        const slidesList = document.getElementById('slides-list');
        const addForm = document.getElementById('add-slide-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const configForm = document.getElementById('config-form'); // NEW
        const configLoadingSpinner = document.getElementById('config-loading-spinner'); // NEW

        function initializeFirebase() {
            try {
                // *** UPDATED: Changed CONFIG.firebaseConfig to firebaseConfig ***
                if (!firebaseConfig || firebaseConfig.apiKey.startsWith("PASTE_")) {
                    document.body.innerHTML = `<div class="p-8 text-red-500 font-bold text-center text-2xl">Error: Firebase config is not set. Please paste your Firebase configuration into the 'CONFIG' object in admin.html.</div>`;
                    return false;
                }
                
                // *** UPDATED: Changed CONFIG.firebaseConfig to firebaseConfig ***
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                // storage = getStorage(app); // NEW: Initialize Storage
                slidesCollection = collection(db, 'slides');
                configDocRef = doc(db, 'config', 'global'); // NEW: Set doc reference

                return true;

            } catch(e) {
                console.error("Failed to initialize Firebase:", e);
                document.body.innerHTML = `<div class="p-8 text-red-500 font-bold text-center text-2xl">Error: Could not initialize Firebase. Check console for details.</div>`;
                return false;
            }
        }

        // ------------------------------
        // NEW: Load Global Config
        // ------------------------------
        async function loadConfig() {
            try {
                const docSnap = await getDoc(configDocRef);
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    // Populate the form
                    document.getElementById('weather_locationName').value = config.weather_locationName || 'South Vienna';
                    document.getElementById('weather_latitude').value = config.weather_latitude || 39.92;
                    document.getElementById('weather_longitude').value = config.weather_longitude || -83.81;
                    document.getElementById('weather_refreshIntervalMinutes').value = config.weather_refreshIntervalMinutes || 10;
                    
                    document.getElementById('googleSlides_scriptUrl').value = config.googleSlides_scriptUrl || '';
                    document.getElementById('googleSlides_embedUrlBase').value = config.googleSlides_embedUrlBase || '';
                    document.getElementById('googleSlides_delayPerSlideSeconds').value = config.googleSlides_delayPerSlideSeconds || 15;
                    document.getElementById('googleSlides_refreshIntervalMinutes').value = config.googleSlides_refreshIntervalMinutes || 60;

                    // *** NEW: Load News Feed Config ***
                    document.getElementById('newsFeed_secondsPerItem').value = config.newsFeed_secondsPerItem || 20;

                    document.getElementById('nwsAlertZone').value = config.nwsAlertZone || 'OHZ054';
                    document.getElementById('nwsAlertRefreshSeconds').value = config.nwsAlertRefreshSeconds || 300;

                    // NEW: Load Active911 config
                    document.getElementById('active911_apiToken').value = config.active911_apiToken || '';
                    document.getElementById('active911_departmentId').value = config.active911_departmentId || '';
                    document.getElementById('active911_pollIntervalSeconds').value = config.active911_pollIntervalSeconds || 60;
                    document.getElementById('active911_alertDurationSeconds').value = config.active911_alertDurationSeconds || 60;

                    // NEW: Load logo URL and preview
                    document.getElementById('logo_url').value = config.logoUrl || '';
                    const preview = document.getElementById('logo-preview');
                    if (config.logoUrl) {
                        preview.src = config.logoUrl;
                    } else {
                        preview.src = 'https://placehold.co/200x100/f1f5f9/94a3b8?text=No+Logo+Set';
                    }

                } else {
                    console.warn("No global config doc found. Using defaults.");
                    // Set defaults in the form
                    document.getElementById('weather_locationName').value = 'South Vienna';
                    document.getElementById('weather_latitude').value = 39.92;
                    document.getElementById('weather_longitude').value = -83.81;
                    document.getElementById('weather_refreshIntervalMinutes').value = 10;
                    document.getElementById('googleSlides_delayPerSlideSeconds').value = 15;
                    document.getElementById('googleSlides_refreshIntervalMinutes').value = 60;
                    // *** NEW: Default News Feed Config ***
                    document.getElementById('newsFeed_secondsPerItem').value = 20;
                    document.getElementById('nwsAlertZone').value = 'OHZ054';
                    document.getElementById('nwsAlertRefreshSeconds').value = 300;
                    // NEW: Default Active911 config
                    document.getElementById('active911_pollIntervalSeconds').value = 60;
                    document.getElementById('active911_alertDurationSeconds').value = 60;
                    // NEW: Set default logo preview
                    document.getElementById('logo_preview').src = 'https://placehold.co/200x100/f1f5f9/94a3b8?text=No+Logo+Set';
                }
            } catch (error) {
                console.error("Error loading config: ", error);
                configLoadingSpinner.innerHTML = `<p class="text-red-500">Error loading settings. Check console.</p>`;
            } finally {
                configLoadingSpinner.style.display = 'none';
                configForm.classList.remove('hidden');
            }
        }

        // ------------------------------
        // NEW: Handle Logo Upload (using ImgBB)
        // ------------------------------
        document.getElementById('upload-logo-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('logo_upload');
            const file = fileInput.files[0];
            const feedback = document.getElementById('upload-feedback');
            const apiKey = document.getElementById('imgbb_api_key').value;

            if (!apiKey) {
                feedback.textContent = 'Please enter your ImgBB API Key.';
                feedback.className = 'ml-4 text-red-600';
                return;
            }
            
            if (!file) {
                feedback.textContent = 'Please select a file first.';
                feedback.className = 'ml-4 text-red-600';
                return;
            }

            feedback.textContent = 'Uploading to ImgBB...';
            feedback.className = 'ml-4 text-blue-600';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (result.success) {
                    const downloadURL = result.data.display_url;

                    // Update the hidden input and preview
                    document.getElementById('logo_url').value = downloadURL;
                    document.getElementById('logo-preview').src = downloadURL;
                    
                    // Save the URL to Firestore immediately
                    await setDoc(configDocRef, { 
                        logoUrl: downloadURL,
                        // lastUpdated: new Date().toISOString() // REMOVED
                    }, { merge: true });
                    
                    feedback.textContent = 'Logo uploaded and saved!';
                    feedback.className = 'ml-4 text-green-600';
                    fileInput.value = ''; // Clear the input
                    
                    setTimeout(() => { feedback.textContent = ''; }, 3000);

                } else {
                    throw new Error(result.error?.message || 'ImgBB upload failed.');
                }

            } catch (error) {
                console.error("Error uploading logo to ImgBB: ", error);
                feedback.textContent = `Upload failed: ${error.message}`;
                feedback.className = 'ml-4 text-red-600';
            }
        });


        // ------------------------------
        // NEW: Handle Save Global Config
        // ------------------------------
        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const configData = {
                weather_locationName: document.getElementById('weather_locationName').value,
                weather_latitude: parseFloat(document.getElementById('weather_latitude').value),
                weather_longitude: parseFloat(document.getElementById('weather_longitude').value),
                weather_refreshIntervalMinutes: parseInt(document.getElementById('weather_refreshIntervalMinutes').value, 10),
                
                googleSlides_scriptUrl: document.getElementById('googleSlides_scriptUrl').value,
                googleSlides_embedUrlBase: document.getElementById('googleSlides_embedUrlBase').value,
                googleSlides_delayPerSlideSeconds: parseInt(document.getElementById('googleSlides_delayPerSlideSeconds').value, 10),
                googleSlides_refreshIntervalMinutes: parseInt(document.getElementById('googleSlides_refreshIntervalMinutes').value, 10),

                // *** NEW: Save News Feed Config ***
                newsFeed_secondsPerItem: parseInt(document.getElementById('newsFeed_secondsPerItem').value, 10),

                nwsAlertZone: document.getElementById('nwsAlertZone').value,
                nwsAlertRefreshSeconds: parseInt(document.getElementById('nwsAlertRefreshSeconds').value, 10),
                
                // NEW: Save Active911 config
                active911_apiToken: document.getElementById('active911_apiToken').value,
                active911_departmentId: parseInt(document.getElementById('active911_departmentId').value, 10) || null,
                active911_pollIntervalSeconds: parseInt(document.getElementById('active911_pollIntervalSeconds').value, 10),
                active911_alertDurationSeconds: parseInt(document.getElementById('active911_alertDurationSeconds').value, 10),

                // NEW: Add logoUrl to the save object
                logoUrl: document.getElementById('logo_url').value,

                // NEW: Add restart trigger
                // lastUpdated: new Date().toISOString() // *** REMOVED TO PREVENT AUTO-REFRESH ***
            };

            try {
                await setDoc(configDocRef, configData); // setDoc will create or overwrite
                const feedback = document.getElementById('save-feedback');
                feedback.classList.remove('hidden');
                feedback.classList.add('flex');
                setTimeout(() => {
                    feedback.classList.add('hidden');
                    feedback.classList.remove('flex');
                }, 2000);
            } catch (error) {
                console.error("Error saving config: ", error);
                alert("Error saving settings. Check console for details.");
            }
        });


        // ------------------------------
        // Render Slide List
        // ------------------------------
        function renderSlides(docs) {
            loadingSpinner.style.display = 'none';
            slidesList.innerHTML = ''; // Clear existing list
            
            if (docs.length === 0) {
                slidesList.innerHTML = `<p class="text-gray-500 text-center">No slides found. Add one using the form above.</p>`;
                return;
            }

            docs.forEach(doc => {
                const slide = doc.data();
                const slideEl = document.createElement('div');
                slideEl.className = 'bg-white p-4 rounded-lg shadow grid grid-cols-1 md:grid-cols-4 gap-4 items-center';
                slideEl.setAttribute('data-id', doc.id);

                // Re-create the src and title from the iframe
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = slide.iframe;
                const iframe = tempDiv.querySelector('iframe');
                const src = iframe ? iframe.src : 'Error: Invalid iframe';
                const title = iframe ? iframe.title : 'No Title';

                slideEl.innerHTML = `
                    <div class="md:col-span-2">
                        <p class="font-bold text-lg text-blue-700">${title}</p>
                        <p class="text-sm text-gray-600 break-all">${src}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">Duration (s)</label>
                        <input type="number" value="${slide.duration / 1000}" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 text-black update-duration">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">Order</label>
                        <input type="number" value="${slide.order}" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 text-black update-order">
                    </div>
                    <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:space-x-2 md:col-start-4">
                        <button class="flex-1 inline-flex justify-center rounded-md border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 update-btn">Save</V>
                        <button class="flex-1 inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 delete-btn">Delete</button>
                    </div>
                `;
                slidesList.appendChild(slideEl);
            });
        }

        // ------------------------------
        // Event Listeners (Slides)
        // ------------------------------
        
        // Listen for realtime slide updates
        function listenToSlides() {
            const q = query(slidesCollection, orderBy('order'));
            onSnapshot(q, (snapshot) => {
                renderSlides(snapshot.docs);
            }, (error) => {
                console.error("Error listening to slides: ", error);
                loadingSpinner.innerHTML = `<p class="text-red-500">Error loading slides. Check console and Firebase rules.</p>`;
            });
        }

        // Handle Add Slide
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('slide-url').value;
            const title = document.getElementById('slide-title').value;
            const duration = parseInt(document.getElementById('slide-duration').value) * 1000;
            const order = parseInt(document.getElementById('slide-order').value);

            // Construct the iframe string
            const iframe = `<iframe title="${title}" src="${url}" frameborder="0" class="w-full h-full"></iframe>`;

            try {
                await addDoc(slidesCollection, {
                    type: 'iframe', // All slides from here are 'iframe' type
                    iframe: iframe,
                    duration: duration,
                    order: order
                });

                // NEW: Trigger dashboard restart
                // await setDoc(configDocRef, { lastUpdated: new Date().toISOString() }, { merge: true }); // REMOVED

                addForm.reset();
            } catch (error) {
                console.error("Error adding slide: ", error);
                alert("Error adding slide. Check console for details.");
            }
        });

        // Handle Update and Delete Slide
        slidesList.addEventListener('click', async (e) => {
            const slideEl = e.target.closest('[data-id]');
            if (!slideEl) return;

            const docId = slideEl.getAttribute('data-id');
            const docRef = doc(db, 'slides', docId);

            // Delete
            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this slide?')) {
                    try {
                        await deleteDoc(docRef);
                        // NEW: Trigger dashboard restart
                        // await setDoc(configDocRef, { lastUpdated: new Date().toISOString() }, { merge: true }); // REMOVED
                    } catch (error) {
                        console.error("Error deleting slide: ", error);
                        alert("Error deleting slide. Check console.");
                    }
                }
            }

            // Update
            if (e.target.classList.contains('update-btn')) {
                try {
                    const newDuration = parseInt(slideEl.querySelector('.update-duration').value) * 1000;
                    const newOrder = parseInt(slideEl.querySelector('.update-order').value);
                    
                    await updateDoc(docRef, {
                        duration: newDuration,
                        order: newOrder
                    });

                    // NEW: Trigger dashboard restart
                    // await setDoc(configDocRef, { lastUpdated: new Date().toISOString() }, { merge: true }); // REMOVED
                    
                    // Give visual feedback
                    e.target.textContent = 'Saved!';
                    e.target.classList.remove('bg-green-600', 'hover:bg-green-700');
                    e.target.classList.add('bg-gray-400');
                    setTimeout(() => {
                        e.target.textContent = 'Save';
                        e.target.classList.add('bg-green-600', 'hover:bg-green-700');
                        e.target.classList.remove('bg-gray-400');
                    }, 1500);

                } catch (error) {
                    console.error("Error updating slide: ", error);
                    alert("Error updating slide. Check console.");
                }
            }
        });

        // ------------------------------
        // NEW: Tab Switching Logic
        // ------------------------------
        function setupTabs() {
            const navTabs = document.querySelectorAll('.nav-tab');
            const tabPanels = document.querySelectorAll('.tab-panel');
            const configContainer = document.getElementById('config-container'); // Get config container
            const activeTabClasses = 'text-blue-600 border-b-2 border-blue-600'.split(' ');
            const inactiveTabClasses = 'text-gray-500 border-transparent border-b-2 hover:text-gray-700 hover:border-gray-300'.split(' ');

            function setActiveTab(tabName) {
                navTabs.forEach(tab => {
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add(...activeTabClasses);
                        tab.classList.remove(...inactiveTabClasses);
                    } else {
                        tab.classList.remove(...activeTabClasses);
                        tab.classList.add(...inactiveTabClasses);
                    }
                });

                tabPanels.forEach(panel => {
                    // Show the panel that matches the tabName
                    if (panel.id === `tab-${tabName}`) {
                        panel.style.display = 'block';
                    } else {
                        panel.style.display = 'none';
                    }
                });

                // NEW: Show/hide the config container based on tab
                if (tabName === 'slide-management') {
                    configContainer.style.display = 'none';
                } else {
                    configContainer.style.display = 'block';
                }
            }

            navTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = e.target.dataset.tab;
                    setActiveTab(tabName);
                });
            });

            // Set initial active tab
            setActiveTab('weather'); // Default to 'weather'
        }


        // ------------------------------
        // NEW: Manual Refresh Button Logic
        // ------------------------------
        function setupManualRefresh() {
            const refreshBtn = document.getElementById('manual-refresh-btn');
            if (!refreshBtn) return;

            refreshBtn.addEventListener('click', async () => {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Refreshing...';
                refreshBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                refreshBtn.classList.add('bg-gray-400');

                try {
                    // This is the trigger for index.html to reload its config
                    await setDoc(configDocRef, { lastUpdated: new Date().toISOString() }, { merge: true });
                    
                    // Visual feedback
                    refreshBtn.textContent = 'Dashboard Refreshed!';
                    refreshBtn.classList.remove('bg-gray-400');
                    refreshBtn.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        refreshBtn.textContent = 'Refresh Dashboard';
                        refreshBtn.classList.remove('bg-green-600');
                        refreshBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        refreshBtn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error("Error triggering manual refresh:", error);
                    refreshBtn.textContent = 'Error!';
                    refreshBtn.classList.remove('bg-gray-400');
                    refreshBtn.classList.add('bg-red-600');
                    
                    setTimeout(() => {
                        refreshBtn.textContent = 'Refresh Dashboard';
                        refreshBtn.classList.remove('bg-red-600');
                        refreshBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        refreshBtn.disabled = false;
                    }, 3000);
                }
            });
        }


        // ------------------------------
        // Start
        // ------------------------------
        if (initializeFirebase()) {
            loadConfig(); // Load the global config
            listenToSlides(); // Load the slides
            setupTabs(); // NEW: Initialize the tab functionality
            setupManualRefresh(); // NEW: Initialize the refresh button
        }

    </script>
</body>
</html>

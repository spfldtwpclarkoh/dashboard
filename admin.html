<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        /* Hide tab panels by default */
        .tab-panel {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen p-8">

    <!-- NEW: Login Wrapper -->
    <div id="login-wrapper" class="max-w-md mx-auto bg-white shadow-md rounded-lg p-8 mt-20">
        <h2 class="text-3xl font-black text-center text-gray-800 mb-6">Admin Login</h2>
        <form id="login-form">
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
            </div>
            <div class="mt-4">
                <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
            </div>
            <div class="mt-6">
                <button type="submit" class="w-full inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700">
                    Sign In
                </button>
            </div>
            <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
        </form>
    </div>

    <!-- NEW: Admin Content Wrapper (hidden by default) -->
    <div id="admin-wrapper" class="max-w-6xl mx-auto hidden">
        <!-- *** UPDATED: Wrapper for title and refresh button *** -->
        <div class="flex justify-between items-center mb-6 flex-wrap">
            <div>
                <h1 class="text-4xl font-black text-gray-800">Dashboard Admin Console</h1>
                <p id="user-email-display" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <div class="flex gap-4 mt-4 md:mt-0">
                <!-- *** NEW: Manual Refresh Button *** -->
                <button id="manual-refresh-btn" class="inline-flex justify-center rounded-lg border border-transparent bg-green-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Refresh Dashboard
                </button>
                <!-- *** NEW: Force Reload Button *** -->
                <button id="force-reload-btn" class="inline-flex justify-center rounded-lg border border-transparent bg-red-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" title="Forces all dashboards to reload and clear their cache. Use if slides are not updating.">
                    Force Reload All
                </button>
                <!-- NEW: Sign Out Button -->
                <button id="sign-out-btn" class="inline-flex justify-center rounded-lg border border-gray-300 bg-white py-2 px-6 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                    Sign Out
                </button>
            </div>
        </div>

        <!-- NEW: Global Error Display -->
        <div id="global-error-panel" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold">Firebase Permissions Error</p>
            <p id="global-error-message">An operation failed. This is likely due to your Firestore Security Rules. Please ensure that authenticated users have write permission for the collections (e.g., 'config', 'alerts', 'slides').</p>
        </div>

        <!-- NEW: Navigation Toolbar -->
        <nav class="mb-6">
            <ul class="flex border-b border-gray-300">
                <li><button data-tab="weather" class="nav-tab py-2 px-4 font-medium">Weather Widget</button></li>
                <li><button data-tab="logo" class="nav-tab py-2 px-4 font-medium">Logo</button></li>
                <li><button data-tab="gslides" class="nav-tab py-2 px-4 font-medium">Google Slides</button></li>
                <!-- *** NEW: News Feed Tab *** -->
                <li><button data-tab="news" class="nav-tab py-2 px-4 font-medium">News Feed</button></li>
                <li><button data-tab="nws" class="nav-tab py-2 px-4 font-medium">NWS/IPAWS Alerts</button></li>
                <!-- *** NEW: Active911 Tab *** -->
                <li><button data-tab="active911" class="nav-tab py-2 px-4 font-medium">Active911</button></li>
                <li><button data-tab="slide-management" class="nav-tab py-2 px-4 font-medium">Slide Management</button></li>
            </ul>
        </nav>

        <!-- NEW: Tab Content Wrapper -->
        <div id="tab-content">

            <!-- Global Config Form (wraps first 4 tabs) -->
            <div id="config-container" class="bg-white p-6 rounded-lg shadow-md mb-8">
                
                <div id="config-loading-spinner" class="text-center p-8">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-600">Loading Settings...</p>
                </div>

                <form id="config-form" class="hidden">
                    
                    <!-- TAB 1: Weather -->
                    <div id="tab-weather" class="tab-panel">
                        <fieldset class="border-t border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Weather Widget</legend>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="weather_locationName" class="block text-sm font-medium text-gray-700">Location Name</label>
                                    <input type="text" id="weather_locationName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="weather_latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
                                    <input type="number" step="any" id="weather_latitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="weather_longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
                                    <input type="number" step="any" id="weather_longitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="weather_refreshIntervalMinutes" class="block text-sm font-medium text-gray-700">Refresh (minutes)</label>
                                    <input type="number" id="weather_refreshIntervalMinutes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- TAB 2: Logo -->
                    <div id="tab-logo" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Dashboard Logo</legend>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="imgbb_api_key" class="block text-sm font-medium text-gray-700">ImgBB API Key</label>
                                    <input type="text" id="imgbb_api_key" placeholder="Your ImgBB API Key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="logo_upload" class="block text-sm font-medium text-gray-700">Upload New Logo</label>
                                <input type="file" id="logo_upload" accept="image/png, image/jpeg, image/gif, image/svg+xml" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <button type="button" id="upload-logo-btn" class="mt-3 inline-flex justify-center rounded-lg border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">
                                    Upload to ImgBB & Save
                                </button>
                                <span id="upload-feedback" class="ml-4 text-gray-600"></span>
                            </div>
                            <div class="mt-4">
                                <p class="block text-sm font-medium text-gray-700">Current Logo Preview:</p>
                                <img id="logo-preview" src="https://placehold.co/200x100/f1f5f9/94a3b8?text=No+Logo+Set" alt="Current Logo Preview" class="mt-2 h-24 w-auto rounded bg-gray-50">
                                <input type="hidden" id="logo_url"> <!-- To store the URL for saving -->
                            </div>
                        </fieldset>
                    </div>

                    <!-- TAB 3: Google Slides -->
                    <div id="tab-gslides" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Google Slides</legend>
                            <div class="form-grid mt-4">
                                <div class="col-span-1 md:col-span-2">
                                    <label for="googleSlides_scriptUrl" class="block text-sm font-medium text-gray-700">Apps Script URL (for slide count)</label>
                                    <input type="url" id="googleSlides_scriptUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <label for="googleSlides_embedUrlBase" class="block text-sm font-medium text-gray-700">Slides Embed URL (Base)</label>
                                    <input type="url" id="googleSlides_embedUrlBase" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="googleSlides_delayPerSlideSeconds" class="block text-sm font-medium text-gray-700">Delay per Slide (sec)</label>
                                    <input type="number" id="googleSlides_delayPerSlideSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="googleSlides_refreshIntervalMinutes" class="block text-sm font-medium text-gray-700">Refresh Count (min)</label>
                                    <input type="number" id="googleSlides_refreshIntervalMinutes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- *** NEW: News Feed Tab Panel *** -->
                    <div id="tab-news" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Rolling News Feed</legend>
                            <p class="text-sm text-gray-600 mt-2">
                                Settings for the standalone news feed slide (`rolling_news.html`).
                                The Google Sheet URL is managed inside the file itself.
                            </p>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="newsFeed_secondsPerItem" class="block text-sm font-medium text-gray-700">Seconds Per Slide</label>
                                    <input type="number" id="newsFeed_secondsPerItem" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    
                    <!-- TAB 4: NWS/IPAWS -->
                    <div id="tab-nws" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">NWS/IPAWS Alerts</legend>
                            <div class="form-grid mt-4">
                                <div>
                                    <label for="nwsAlertZone" class="block text-sm font-medium text-gray-700">NWS Alert Zone (e.g., OHZ054)</label>
                                    <input type="text" id="nwsAlertZone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="nwsAlertRefreshSeconds" class="block text-sm font-medium text-gray-700">Alert Refresh (sec)</label>
                                    <input type="number" id="nwsAlertRefreshSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                            </div>
                            <!-- NEW: Test Button -->
                            <div class="mt-6">
                                <h3 class="text-md font-medium text-gray-900">Test Manual Alert</h3>
                                <p class="text-sm text-gray-600 mt-1">This will trigger the red NWS/IPAWS alert overlay on all dashboards.</p>
                                <button type="button" id="test-manual-alert-btn" class="mt-3 inline-flex justify-center rounded-lg border border-transparent bg-yellow-500 py-2 px-4 text-sm font-medium text-black shadow-sm hover:bg-yellow-600">
                                    Send Test Alert
                                </button>
                                <span id="test-manual-feedback" class="ml-4 text-gray-600"></span>
                            </div>
                        </fieldset>
                    </div>

                    <!-- NEW: Active911 Tab Panel -->
                    <div id="tab-active911" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Active911 Alerts</legend>
                            <p class="text-sm text-gray-600 mt-2">
                                Polls Active911 for new alerts for a specific department.
                            </p>
                            <div class="form-grid mt-4">
                                <div class="col-span-1 md:col-span-2">
                                    <label for="active911_apiToken" class="block text-sm font-medium text-gray-700">API Token</label>
                                    <input type="password" id="active911_apiToken" placeholder="Your Active911 API Token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="active911_departmentId" class="block text-sm font-medium text-gray-700">Department ID</label>
                                    <input type="number" id="active911_departmentId" placeholder="1234" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="active911_pollIntervalSeconds" class="block text-sm font-medium text-gray-700">Poll Interval (seconds)</label>
                                    <input type="number" id="active911_pollIntervalSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <div>
                                    <label for="active911_alertDurationSeconds" class="block text-sm font-medium text-gray-700">Alert Display (seconds)</label>
                                    <input type="number" id="active911_alertDurationSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                </div>
                                <!-- NEW: Alert Sound Selection -->
                                <div>
                                    <label for="active911_alertTone" class="block text-sm font-medium text-gray-700">Alert Sound</label>
                                    <select id="active911_alertTone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
                                        <option value="alarm">Alarm (alarm.mp3)</option>
                                        <option value="default">Default (default.mp3)</option>
                                    </select>
                                </div>
                            </div>
                            <!-- NEW: Test Button -->
                            <div class="mt-6">
                                <h3 class="text-md font-medium text-gray-900">Test Active911 Alert</h3>
                                <p class="text-sm text-gray-600 mt-1">This will trigger the red Active911 alert overlay on all dashboards.</p>
                                <button type="button" id="test-active911-alert-btn" class="mt-3 inline-flex justify-center rounded-lg border border-transparent bg-red-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700">
                                    Send Test Alert
                                </button>
                                <span id="test-active911-feedback" class="ml-4 text-gray-600"></span>
                            </div>
                        </fieldset>
                    </div>

                    <!-- This save button applies to all config tabs -->
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Save Settings
                        </button>
                        <span id="save-feedback" class="ml-4 text-green-600 font-medium items-center hidden">Saved!</span>
                    </div>
                </form>
            </div>

            <!-- TAB 5: Slide Management -->
            <div id="tab-slide-management" class="tab-panel">
                <!-- Add New Slide Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-bold mb-4">Add New Slide</h2>
                    <form id="add-slide-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label for="slide-url" class="block text-sm font-medium text-gray-700">Slide URL (src)</label>
                            <!-- *** UPDATED: Changed type="url" to type="text" to allow relative paths *** -->
                            <input type="text" id="slide-url" placeholder="https://example.com or ./local/page.html" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div>
                            <label for="slide-title" class="block text-sm font-medium text-gray-700">Title (for iframe)</label>
                            <input type="text" id="slide-title" placeholder="My Slide Title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div>
                            <label for="slide-duration" class="block text-sm font-medium text-gray-700">Duration (seconds)</label>
                            <input type="number" id="slide-duration" value="20" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div>
                            <label for="slide-order" class="block text-sm font-medium text-gray-700">Order</label>
                            <input type="number" id="slide-order" value="10" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-black">
                        </div>
                        <div class="md:col-span-3 flex justify-end">
                            <button type="submit" class="inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                Add Slide
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Current Slides List -->
                <div>
                    <h2 class="text-2xl font-bold mb-4">Current Slides</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Note: The 'Google Slides' entry is managed automatically by the dashboard and is not shown here.
                    </p>
                    <div id="loading-spinner" class="text-center">
                        <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-gray-600">Loading Slides...</p>
                    </div>
                    <div id="slides-list" class="space-y-4">
                        <!-- Slides will be injected here by JavaScript -->
                    </div>
                </div>
            </div> <!-- End #tab-slide-management -->

        </div> <!-- End #tab-content -->
    </div> <!-- End #admin-wrapper -->

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        // NEW: Import Auth modules
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        // ------------------------------
        // CONFIGURATION
        // ------------------------------
        const firebaseConfig = {
          apiKey: "AIzaSyCew0RUOwuFT-rplkh6h80UBnKPOfrn7qo",
          authDomain: "stfd-dashboard.firebaseapp.com",
          projectId: "stfd-dashboard",
          storageBucket: "stfd-dashboard.firebasestorage.app",
          messagingSenderId: "54058446605",
          appId: "1:54058446605:web:ec492afcb8620109628a44",
          measurementId: "G-4N22BEGSF7"
        };

        // ------------------------------
        // Firebase Initialization
        // ------------------------------
        let db;
        let auth; // NEW
        let slidesCollection;
        let configDocRef;
        let manualAlertDocRef;
        let testActive911DocRef;
        let forceReloadDocRef; // *** NEW ***

        // --- NEW DOM Elements ---
        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const globalErrorPanel = document.getElementById('global-error-panel'); // NEW
        const globalErrorMessage = document.getElementById('global-error-message'); // NEW

        const slidesList = document.getElementById('slides-list');
        const addForm = document.getElementById('add-slide-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const configForm = document.getElementById('config-form');
        const configLoadingSpinner = document.getElementById('config-loading-spinner');

        function initializeFirebase() {
            try {
                if (!firebaseConfig || firebaseConfig.apiKey.startsWith("PASTE_")) {
                    document.body.innerHTML = `<div class="p-8 text-red-500 font-bold text-center text-2xl">Error: Firebase config is not set.</div>`;
                    return false;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // NEW
                slidesCollection = collection(db, 'slides');
                configDocRef = doc(db, 'config', 'global');
                manualAlertDocRef = doc(db, 'alerts', 'manual_alert');
                testActive911DocRef = doc(db, 'alerts', 'test_active911');
                forceReloadDocRef = doc(db, 'alerts', 'force_reload'); // *** NEW ***

                return true;

            } catch(e) {
                console.error("Failed to initialize Firebase:", e);
                document.body.innerHTML = `<div class="p-8 text-red-500 font-bold text-center text-2xl">Error: Could not initialize Firebase. Check console.</div>`;
                return false;
            }
        }

        // ------------------------------
        // NEW: Global Error Handler
        // ------------------------------
        function showGlobalError(error) {
            console.error("Firebase Error:", error.message, error.code); // Log the full error

            if (error.code === 'permission-denied' || error.message.includes("Missing or insufficient permissions")) {
                globalErrorMessage.innerHTML = `<strong>Error:</strong> ${error.message}<br><strong>This is a Firestore Security Rules problem.</strong> Your currently signed-in user ('${auth.currentUser.email}') does not have permission to perform this action. Please update your Firestore rules in the Firebase Console to grant write access to authenticated users for the 'alerts', 'config', and 'slides' collections.`;
                globalErrorPanel.classList.remove('hidden');
            } else {
                // Show a more generic error
                globalErrorMessage.innerHTML = `<strong>An unexpected error occurred:</strong> ${error.message}<br>Check the console for more details.`;
                globalErrorPanel.classList.remove('hidden');
            }
        }
        
        function hideGlobalError() {
            globalErrorPanel.classList.add('hidden');
            globalErrorMessage.textContent = '';
        }

        // ------------------------------
        // Load Global Config
        // ------------------------------
        async function loadConfig() {
            try {
                // Show spinner, hide form
                configLoadingSpinner.style.display = 'block';
                configForm.classList.add('hidden');
                hideGlobalError(); // Clear errors on load

                const docSnap = await getDoc(configDocRef);
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    // Populate the form
                    document.getElementById('weather_locationName').value = config.weather_locationName || 'South Vienna';
                    document.getElementById('weather_latitude').value = config.weather_latitude || 39.92;
                    document.getElementById('weather_longitude').value = config.weather_longitude || -83.81;
                    document.getElementById('weather_refreshIntervalMinutes').value = config.weather_refreshIntervalMinutes || 10;
                    
                    document.getElementById('googleSlides_scriptUrl').value = config.googleSlides_scriptUrl || '';
                    document.getElementById('googleSlides_embedUrlBase').value = config.googleSlides_embedUrlBase || '';
                    document.getElementById('googleSlides_delayPerSlideSeconds').value = config.googleSlides_delayPerSlideSeconds || 15;
                    document.getElementById('googleSlides_refreshIntervalMinutes').value = config.googleSlides_refreshIntervalMinutes || 60;

                    document.getElementById('newsFeed_secondsPerItem').value = config.newsFeed_secondsPerItem || 20;

                    document.getElementById('nwsAlertZone').value = config.nwsAlertZone || 'OHZ054';
                    document.getElementById('nwsAlertRefreshSeconds').value = config.nwsAlertRefreshSeconds || 300;

                    document.getElementById('active911_apiToken').value = config.active911_apiToken || '';
                    document.getElementById('active911_departmentId').value = config.active911_departmentId || '';
                    document.getElementById('active911_pollIntervalSeconds').value = config.active911_pollIntervalSeconds || 60;
                    document.getElementById('active911_alertDurationSeconds').value = config.active911_alertDurationSeconds || 60;
                    document.getElementById('active911_alertTone').value = config.active911_alertTone || 'alarm';

                    document.getElementById('logo_url').value = config.logoUrl || '';
                    const preview = document.getElementById('logo-preview');
                    if (config.logoUrl) {
                        preview.src = config.logoUrl;
                    } else {
                        preview.src = 'https://placehold.co/200x100/f1f5f9/94a3b8?text=No+Logo+Set';
                    }

                } else {
                    console.warn("No global config doc found. Using defaults.");
                    // Set defaults in the form
                    document.getElementById('weather_locationName').value = 'South Vienna';
                    document.getElementById('weather_latitude').value = 39.92;
                    document.getElementById('weather_longitude').value = -83.81;
                    document.getElementById('weather_refreshIntervalMinutes').value = 10;
                    document.getElementById('googleSlides_delayPerSlideSeconds').value = 15;
                    document.getElementById('googleSlides_refreshIntervalMinutes').value = 60;
                    document.getElementById('newsFeed_secondsPerItem').value = 20;
                    document.getElementById('nwsAlertZone').value = 'OHZ054';
                    document.getElementById('nwsAlertRefreshSeconds').value = 300;
                    document.getElementById('active911_pollIntervalSeconds').value = 60;
                    document.getElementById('active911_alertDurationSeconds').value = 60;
                    document.getElementById('active911_alertTone').value = 'alarm';
                    document.getElementById('logo_preview').src = 'https://placehold.co/200x100/f1f5f9/94a3b8?text=No+Logo+Set';
                }
            } catch (error) {
                // console.error("Error loading config: ", error); // OLD
                showGlobalError(error); // NEW
                configLoadingSpinner.innerHTML = `<p class="text-red-500">Error loading settings. Check error panel above.</p>`;
            } finally {
                // Hide spinner, show form (if error didn't hide it)
                if(configLoadingSpinner.style.display !== 'none') {
                    configLoadingSpinner.style.display = 'none';
                    configForm.classList.remove('hidden');
                }
            }
        }

        // ------------------------------
        // Handle Logo Upload (using ImgBB)
        // ------------------------------
        document.getElementById('upload-logo-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('logo_upload');
            const file = fileInput.files[0];
            const feedback = document.getElementById('upload-feedback');
            const apiKey = document.getElementById('imgbb_api_key').value;
            hideGlobalError(); // NEW

            if (!apiKey) {
                feedback.textContent = 'Please enter your ImgBB API Key.';
                feedback.className = 'ml-4 text-red-600';
                return;
            }
            
            if (!file) {
                feedback.textContent = 'Please select a file first.';
                feedback.className = 'ml-4 text-red-600';
                return;
            }

            feedback.textContent = 'Uploading to ImgBB...';
            feedback.className = 'ml-4 text-blue-600';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`httpshttps://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (result.success) {
                    const downloadURL = result.data.display_url;

                    document.getElementById('logo_url').value = downloadURL;
                    document.getElementById('logo-preview').src = downloadURL;
                    
                    // Save the URL to Firestore immediately
                    await setDoc(configDocRef, { 
                        logoUrl: downloadURL,
                    }, { merge: true });
                    
                    feedback.textContent = 'Logo uploaded and saved!';
                    feedback.className = 'ml-4 text-green-600';
                    fileInput.value = ''; // Clear the input
                    
                    setTimeout(() => { feedback.textContent = ''; }, 3000);

                } else {
                    throw new Error(result.error?.message || 'ImgBB upload failed.');
                }

            } catch (error) {
                // console.error("Error uploading logo to ImgBB: ", error); // OLD
                feedback.textContent = `Upload failed.`;
                feedback.className = 'ml-4 text-red-600';
                showGlobalError(error); // NEW
            }
        });


        // ------------------------------
        // Handle Save Global Config
        // ------------------------------
        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideGlobalError(); // NEW
            const configData = {
                weather_locationName: document.getElementById('weather_locationName').value,
                weather_latitude: parseFloat(document.getElementById('weather_latitude').value),
                weather_longitude: parseFloat(document.getElementById('weather_longitude').value),
                weather_refreshIntervalMinutes: parseInt(document.getElementById('weather_refreshIntervalMinutes').value, 10),
                
                googleSlides_scriptUrl: document.getElementById('googleSlides_scriptUrl').value,
                googleSlides_embedUrlBase: document.getElementById('googleSlides_embedUrlBase').value,
                googleSlides_delayPerSlideSeconds: parseInt(document.getElementById('googleSlides_delayPerSlideSeconds').value, 10),
                googleSlides_refreshIntervalMinutes: parseInt(document.getElementById('googleSlides_refreshIntervalMinutes').value, 10),

                newsFeed_secondsPerItem: parseInt(document.getElementById('newsFeed_secondsPerItem').value, 10),

                nwsAlertZone: document.getElementById('nwsAlertZone').value,
                nwsAlertRefreshSeconds: parseInt(document.getElementById('nwsAlertRefreshSeconds').value, 10),
                
                active911_apiToken: document.getElementById('active911_apiToken').value,
                active911_departmentId: parseInt(document.getElementById('active911_departmentId').value, 10) || null,
                active911_pollIntervalSeconds: parseInt(document.getElementById('active911_pollIntervalSeconds').value, 10),
                active911_alertDurationSeconds: parseInt(document.getElementById('active911_alertDurationSeconds').value, 10),
                active911_alertTone: document.getElementById('active911_alertTone').value,

                logoUrl: document.getElementById('logo_url').value,
            };

            try {
                await setDoc(configDocRef, configData);
                const feedback = document.getElementById('save-feedback');
                feedback.classList.remove('hidden');
                feedback.classList.add('flex');
                setTimeout(() => {
                    feedback.classList.add('hidden');
                    feedback.classList.remove('flex');
                }, 2000);
            } catch (error) {
                // console.error("Error saving config: ", error); // OLD
                // alert("Error saving settings. Check console for details."); // OLD
                showGlobalError(error); // NEW
            }
        });

        // ------------------------------
        // Render Slide List
        // ------------------------------
        function renderSlides(docs) {
            loadingSpinner.style.display = 'none';
            slidesList.innerHTML = '';
            
            if (docs.length === 0) {
                slidesList.innerHTML = `<p class="text-gray-500 text-center">No slides found. Add one using the form above.</p>`;
                return;
            }

            docs.forEach(doc => {
                const slide = doc.data();
                const slideEl = document.createElement('div');
                slideEl.className = 'bg-white p-4 rounded-lg shadow grid grid-cols-1 md:grid-cols-4 gap-4 items-center';
                slideEl.setAttribute('data-id', doc.id);

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = slide.iframe;
                const iframe = tempDiv.querySelector('iframe');
                const src = iframe ? iframe.src : 'Error: Invalid iframe';
                const title = iframe ? iframe.title : 'No Title';

                slideEl.innerHTML = `
                    <div class="md:col-span-2">
                        <p class="font-bold text-lg text-blue-700">${title}</p>
                        <p class="text-sm text-gray-600 break-all">${src}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">Duration (s)</label>
                        <input type="number" value="${slide.duration / 1000}" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 text-black update-duration">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">Order</label>
                        <input type="number" value="${slide.order}" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 text-black update-order">
                    </div>
                    <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:space-x-2 md:col-start-4">
                        <button class="flex-1 inline-flex justify-center rounded-md border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 update-btn">Save</V>
                        <button class="flex-1 inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 delete-btn">Delete</button>
                    </div>
                `;
                slidesList.appendChild(slideEl);
            });
        }

        // ------------------------------
        // Event Listeners (Slides)
        // ------------------------------
        
        function listenToSlides() {
            hideGlobalError(); // NEW
            const q = query(slidesCollection, orderBy('order'));
            onSnapshot(q, (snapshot) => {
                renderSlides(snapshot.docs);
            }, (error) => {
                // console.error("Error listening to slides: ", error); // OLD
                showGlobalError(error); // NEW
                loadingSpinner.innerHTML = `<p class="text-red-500">Error loading slides. Check error panel above.</p>`;
            });
        }

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideGlobalError(); // NEW

            const url = document.getElementById('slide-url').value;
            const title = document.getElementById('slide-title').value;
            const duration = parseInt(document.getElementById('slide-duration').value) * 1000;
            const order = parseInt(document.getElementById('slide-order').value);

            const iframe = `<iframe title="${title}" src="${url}" frameborder="0" class="w-full h-full"></iframe>`;

            try {
                await addDoc(slidesCollection, {
                    type: 'iframe',
                    iframe: iframe,
                    duration: duration,
                    order: order
                });
                addForm.reset();
            } catch (error) {
                // console.error("Error adding slide: ", error); // OLD
                // alert("Error adding slide. Check console for details."); // OLD
                showGlobalError(error); // NEW
            }
        });

        slidesList.addEventListener('click', async (e) => {
            const slideEl = e.target.closest('[data-id]');
            if (!slideEl) return;
            hideGlobalError(); // NEW

            const docId = slideEl.getAttribute('data-id');
            const docRef = doc(db, 'slides', docId);

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this slide?')) {
                    try {
                        await deleteDoc(docRef);
                    } catch (error) {
                        // console.error("Error deleting slide: ", error); // OLD
                        // alert("Error deleting slide. Check console."); // OLD
                        showGlobalError(error); // NEW
                    }
                }
            }

            if (e.target.classList.contains('update-btn')) {
                try {
                    const newDuration = parseInt(slideEl.querySelector('.update-duration').value) * 1000;
                    const newOrder = parseInt(slideEl.querySelector('.update-order').value);
                    
                    await updateDoc(docRef, {
                        duration: newDuration,
                        order: newOrder
                    });
                    
                    e.target.textContent = 'Saved!';
                    e.target.classList.remove('bg-green-600', 'hover:bg-green-700');
                    e.target.classList.add('bg-gray-400');
                    setTimeout(() => {
                        e.target.textContent = 'Save';
                        e.target.classList.add('bg-green-600', 'hover:bg-green-700');
                        e.target.classList.remove('bg-gray-400');
                    }, 1500);

                } catch (error) {
                    // console.error("Error updating slide: ", error); // OLD
                    // alert("Error updating slide. Check console."); // OLD
                    showGlobalError(error); // NEW
                }
            }
        });

        // ------------------------------
        // Tab Switching Logic
        // ------------------------------
        function setupTabs() {
            const navTabs = document.querySelectorAll('.nav-tab');
            const tabPanels = document.querySelectorAll('.tab-panel');
            const configContainer = document.getElementById('config-container');
            const activeTabClasses = 'text-blue-600 border-b-2 border-blue-600'.split(' ');
            const inactiveTabClasses = 'text-gray-500 border-transparent border-b-2 hover:text-gray-700 hover:border-gray-300'.split(' ');

            function setActiveTab(tabName) {
                navTabs.forEach(tab => {
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add(...activeTabClasses);
                        tab.classList.remove(...inactiveTabClasses);
                    } else {
                        tab.classList.remove(...activeTabClasses);
                        tab.classList.add(...inactiveTabClasses);
                    }
                });

                tabPanels.forEach(panel => {
                    if (panel.id === `tab-${tabName}`) {
                        panel.style.display = 'block';
                    } else {
                        panel.style.display = 'none';
                    }
                });

                if (tabName === 'slide-management') {
                    configContainer.style.display = 'none';
                } else {
                    configContainer.style.display = 'block';
                }
            }

            navTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideGlobalError(); // NEW: Hide error when switching tabs
                    const tabName = e.target.dataset.tab;
                    setActiveTab(tabName);
                });
            });

            setActiveTab('weather'); // Default to 'weather'
        }


        // ------------------------------
        // Manual Refresh Button Logic
        // ------------------------------
        function setupManualRefresh() {
            const refreshBtn = document.getElementById('manual-refresh-btn');
            if (!refreshBtn) return;

            refreshBtn.addEventListener('click', async () => {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Refreshing...';
                refreshBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                refreshBtn.classList.add('bg-gray-400');
                hideGlobalError(); // NEW

                try {
                    await setDoc(configDocRef, { lastUpdated: new Date().toISOString() }, { merge: true });
                    
                    refreshBtn.textContent = 'Dashboard Refreshed!';
                    refreshBtn.classList.remove('bg-gray-400');
                    refreshBtn.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        refreshBtn.textContent = 'Refresh Dashboard';
                        refreshBtn.classList.remove('bg-green-600');
                        refreshBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        refreshBtn.disabled = false;
                    }, 2000);

                } catch (error) {
                    // console.error("Error triggering manual refresh:", error); // OLD
                    showGlobalError(error); // NEW
                    refreshBtn.textContent = 'Error!';
                    refreshBtn.classList.remove('bg-gray-400');
                    refreshBtn.classList.add('bg-red-600');
                    
                    setTimeout(() => {
                        refreshBtn.textContent = 'Refresh Dashboard';
                        refreshBtn.classList.remove('bg-red-600');
                        refreshBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        refreshBtn.disabled = false;
                    }, 3000);
                }
            });
        }

        // ------------------------------
        // Test Alert Button Handlers
        // ------------------------------
        function setupTestButtons() {
            const testManualBtn = document.getElementById('test-manual-alert-btn');
            const testManualFeedback = document.getElementById('test-manual-feedback');
            
            testManualBtn.addEventListener('click', async () => {
                testManualBtn.disabled = true;
                testManualFeedback.textContent = 'Sending...';
                hideGlobalError(); // NEW
                try {
                    await setDoc(manualAlertDocRef, {
                        title: "MANUAL ALERT TEST",
                        message: "This is a test of the manual alert system.",
                        duration: 15000, // 15 seconds
                        tone: "chime",
                        timestamp: new Date().toISOString()
                    });
                    testManualFeedback.textContent = 'Test alert sent!';
                } catch (e) {
                    // console.error("Error sending test manual alert:", e); // OLD
                    showGlobalError(e); // NEW
                    testManualFeedback.textContent = 'Error!';
                }
                setTimeout(() => {
                    testManualBtn.disabled = false;
                    testManualFeedback.textContent = '';
                }, 2000);
            });

            const testActive911Btn = document.getElementById('test-active911-alert-btn');
            const testActive911Feedback = document.getElementById('test-active911-feedback');

            testActive911Btn.addEventListener('click', async () => {
                testActive911Btn.disabled = true;
                testActive911Feedback.textContent = 'Sending...';
                hideGlobalError(); // NEW
                try {
                    await setDoc(testActive911DocRef, {
                        timestamp: new Date().toISOString()
                    });
                    testActive911Feedback.textContent = 'Test alert sent!';
                } catch (e) {
                    // console.error("Error sending test Active911 alert:", e); // OLD
                    showGlobalError(e); // NEW
                    testActive911Feedback.textContent = 'Error!';
                }
                setTimeout(() => {
                    testActive911Btn.disabled = false;
                    testActive911Feedback.textContent = '';
                }, 2000);
            });
        }

        // ------------------------------
        // NEW: Force Reload Button Logic
        // ------------------------------
        function setupForceReload() {
            const reloadBtn = document.getElementById('force-reload-btn');
            if (!reloadBtn) return;

            reloadBtn.addEventListener('click', async () => {
                if (!confirm('This will force ALL dashboards to reload, clearing their cache. This can be disruptive. Are you sure?')) {
                    return;
                }

                reloadBtn.disabled = true;
                reloadBtn.textContent = 'Reloading...';
                reloadBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                reloadBtn.classList.add('bg-gray-400');
                hideGlobalError();

                try {
                    // Set the document to trigger the reload
                    await setDoc(forceReloadDocRef, { 
                        timestamp: new Date().toISOString(),
                        triggeredBy: auth.currentUser?.email || 'unknown'
                    });
                    
                    reloadBtn.textContent = 'Signal Sent!';
                    reloadBtn.classList.remove('bg-gray-400');
                    reloadBtn.classList.add('bg-green-600'); // Change to green on success
                    
                    setTimeout(() => {
                        reloadBtn.textContent = 'Force Reload All';
                        reloadBtn.classList.remove('bg-green-600');
                        reloadBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        reloadBtn.disabled = false;
                    }, 2000);

                } catch (error) {
                    showGlobalError(error);
                    reloadBtn.textContent = 'Error!';
                    
                    setTimeout(() => {
                        reloadBtn.textContent = 'Force Reload All';
                        reloadBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        reloadBtn.disabled = false;
                    }, 3000);
                }
            });
        }

        // ------------------------------
        // NEW: Auth Logic
        // ------------------------------
        function setupAuthListener() {
            if (!initializeFirebase()) {
                loginError.textContent = "Failed to initialize Firebase. Check console.";
                loginWrapper.classList.remove('hidden');
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    console.log("User signed in:", user.email);
                    loginWrapper.classList.add('hidden');
                    adminWrapper.classList.remove('hidden');
                    userEmailDisplay.textContent = `Signed in as: ${user.email}`;
                    hideGlobalError(); // NEW

                    // Now that we're authenticated, load the app data
                    loadConfig();
                    listenToSlides();
                    setupTabs();
                    setupManualRefresh();
                    setupTestButtons();
                    setupForceReload(); // *** NEW ***
                } else {
                    // User is signed out
                    console.log("User signed out.");
                    loginWrapper.classList.remove('hidden');
                    adminWrapper.classList.add('hidden');
                    userEmailDisplay.textContent = '';
                    hideGlobalError(); // NEW
                    // Clear sensitive data from form if needed, though it's hidden
                    configForm.reset(); 
                    slidesList.innerHTML = '';
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.textContent = '';
                hideGlobalError(); // NEW
                const email = loginEmail.value;
                const password = loginPassword.value;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle hiding the form
                } catch (error) {
                    console.error("Login failed:", error.message);
                    loginError.textContent = "Login failed. Please check your email and password.";
                }
            });

            signOutBtn.addEventListener('click', async () => {
                hideGlobalError(); // NEW
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle showing the login form
                } catch (error) {
                    console.error("Sign out failed:", error);
                }
            });
        }

        // ------------------------------
        // Start
        // ------------------------------
        setupAuthListener(); // This is the new starting point

    </script>
</body>
</html>

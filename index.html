<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STFD DASHBOARD</title>
  <link rel="icon" type="image/x-icon" href="favicon6.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    /* Custom font family */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Ensure feather icons are sized correctly */
    .feather {
      width: 1em;
      height: 1em;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
  </style>
</head>
<!-- UPDATED: Changed w-screen to w-full to prevent potential overflow -->
<body class="bg-gray-900 text-white flex flex-col h-screen w-full overflow-hidden">

  <!-- Main content area (sidebar + slides) -->
  <div class="flex-grow flex flex-col md:flex-row min-h-0">
    <!-- Toolbar / Sidebar -->
    <aside class="w-full md:w-64 bg-gray-800 text-white flex md:flex-col justify-around md:justify-between items-center p-4 md:p-5 flex-shrink-0 z-20 shadow-lg">
      <div class="flex flex-col items-center text-center">
        <!-- UPDATED: Added id="dashboard-logo" -->
        <img id="dashboard-logo" src="logo.png" alt="Harmony Township Logo" class="w-40 md:w-60 h-auto rounded-lg" onerror="this.style.display='none'">
      </div>

      <!-- Weather Widget -->
      <div id="toolbar-weather-widget" class="text-center">
          <!-- NEW: Weather Icon -->
          <div id="weather-icon-container" class="text-6xl text-blue-300 mx-auto mb-2 h-16 flex items-center justify-center">
              <i data-feather="loader" class="animate-spin"></i>
          </div>
          <p id="weather-temp" class="text-6xl font-black">--°</p>
          <p id="weather-condition" class="text-2xl text-gray-300 mt-2">Loading...</p>
          <p id="weather-location" class="text-xl font-bold mt-2">...</p>
          <p id="weather-high-low" class="text-md text-gray-400">H: --° L: --°</p>
      </div>
      
      <!-- Clock Container -->
      <div id="clock-container" class="w-48 md:w-full h-20 transition-all duration-300 ease-in-out">
          <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" class="w-full h-full" allowtransparency="true"></iframe>
      </div>
    </aside>

    <!-- Main Content Slides -->
    <!-- UPDATED: Removed h-full and added min-h-0 to ensure proper flex scaling -->
    <main class="flex-grow relative min-h-0">
      <div class="slides" id="slidesContainer">
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
      </div>
    </main>
  </div>


  <!-- IPAWS / NWS Alert Overlay -->
  <div id="ipawsAlertOverlay" class="fixed inset-0 bg-black bg-opacity-95 text-red-500 text-3xl md:text-5xl font-black flex justify-center items-center text-center z-[9999] p-5 leading-tight opacity-0 invisible transition-opacity duration-500">
    <!-- Alert content will be injected here -->
  </div>
  
  <!-- NEW: Active911 Alert Overlay -->
  <div id="active911AlertOverlay" class="fixed inset-0 bg-black bg-opacity-95 text-white flex justify-center items-center z-[10000] p-5 opacity-0 invisible transition-opacity duration-500">
      <!-- Active911 content will be injected here -->
  </div>

  <!-- Ticker Iframe -->
  <footer id="ticker-footer" class="fixed bottom-0 left-0 w-full h-20 z-50 hidden">
    <iframe src="ticker.html" class="w-full h-full border-none"></iframe>
  </footer>


  <audio id="alertSound"></audio>

  <script type="module">
    // Firebase v9+ Modular Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
    import { getFirestore, doc, onSnapshot, deleteDoc, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";
 
    document.addEventListener('DOMContentLoaded', async () => {

        // ------------------------------
        // Configuration
        // ------------------------------
        // ONLY Firebase config remains. All other settings are fetched from Firestore.
        const firebaseConfig = {
          apiKey: "AIzaSyCew0RUOwuFT-rplkh6h80UBnKPOfrn7qo",
          authDomain: "stfd-dashboard.firebaseapp.com",
          projectId: "stfd-dashboard",
          storageBucket: "stfd-dashboard.firebasestorage.app",
          messagingSenderId: "54058446605",
          appId: "1:54058446605:web:ec492afcb8620109628a44",
          measurementId: "G-4N22BEGSF7"
        };

        // NEW: Global state variables
        let db; // Firestore instance
        let dashboardConfig = null; // Will hold settings from Firestore
        let slideSources = []; // Will hold slides from Firestore
        const shownAlerts = new Set();
        const shownActive911Alerts = new Set(); // NEW
        
        // NEW: Interval timers
        let ipawsInterval = null;
        let weatherInterval = null;
        let slidesRefreshInterval = null;
        let slideRotationTimer = null;
        let active911Interval = null; // NEW

        // Slide rotation state
        const slideDivs = document.querySelectorAll('.slide');
        let contentIndex = 0;
        let activeSlideIndex = 0;
        // This is the special Google Slides object. It will be merged with data from Firestore.
        const googleSlideSource = { 
            type: 'googleslides', 
            iframe: ``, 
            duration: 20000,
            order: 1 // NEW: Give a default order
        };
        
        // *** NEW: Special News Feed slide object ***
        const newsFeedSlideSource = {
            type: 'newsfeed',
            iframe: `<iframe title="News Feed" src="./rolling_news.html" frameborder="0" class="w-full h-full"></iframe>`,
            duration: 60000, // Default 60s, will be updated by postMessage
            order: 2 // NEW: Give a default order (runs after Google Slides)
        };


        // ------------------------------
        // Ticker Communication
        // ------------------------------
        window.addEventListener('message', (event) => {
            const tickerFooter = document.getElementById('ticker-footer');
            const clockContainer = document.getElementById('clock-container');
            
            if (event.data && typeof event.data.tickerActive !== 'undefined') {
                if (event.data.tickerActive) {
                    tickerFooter.classList.remove('hidden');
                    clockContainer.classList.add('md:mb-20');
                } else {
                    tickerFooter.classList.add('hidden');
                    clockContainer.classList.remove('md:mb-20');
                }
            }

            // *** NEW: Listen for messages from the News Feed iframe ***
            if (event.data && event.data.type === 'newsFeedDuration') {
                const newDuration = event.data.totalDuration;
                console.log(`[Dashboard] Received news feed duration: ${newDuration}ms`);
                
                // Find the news feed slide source and update its duration
                const newsSlide = slideSources.find(s => s.type === 'newsfeed');
                if (newsSlide) {
                    newsSlide.duration = newDuration;
                    console.log(`[Dashboard] News feed slide duration set to ${newDuration}ms. (Will be skipped if 0)`);
                }
            }
        });

        // ------------------------------
        // Audio Context and Sound Playback
        // ------------------------------
        let audioEnabled = false;
        const alertAudioElement = document.getElementById('alertSound');
        const toneFileMap = {
            'default': 'default.mp3', 'alarm': 'alarm.mp3',
            'chime': 'chime.mp3', 'ascending': 'ascending.mp3'
        };

        function playAlertSound(toneName = 'default') {
            if (!audioEnabled) {
              console.warn("Audio not enabled by user yet. Click anywhere to enable.");
              return;
            }
            const fileName = toneFileMap[toneName] || toneName;
            alertAudioElement.src = fileName;
            alertAudioElement.play().catch(error => {
              console.error(`Error playing sound "${fileName}":`, error);
              const overlay = document.getElementById("ipawsAlertOverlay");
              const errorSpan = document.createElement('span');
              errorSpan.textContent = ` [Audio file not found: ${fileName}]`;
              errorSpan.className = 'text-yellow-500 text-xl block mt-4';
              if (!overlay.querySelector('span')) overlay.appendChild(errorSpan);
            });
        }

        function enableAudio() {
          if (audioEnabled) return;
          audioEnabled = true;
          alertAudioElement.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";
          alertAudioElement.play().catch(()=>{});
          alertAudioElement.pause();
          alertAudioElement.currentTime = 0;
          console.log('Audio context started by user interaction.');
          window.removeEventListener('click', enableAudio);
          window.removeEventListener('keydown', enableAudio);
        }
        window.addEventListener('click', enableAudio);
        window.addEventListener('keydown', enableAudio);

        // ------------------------------
        // Slide Rotation Logic
        // ------------------------------
        
        async function setupGoogleSlides() {
            // NEW: Guard against config not being loaded
            if (!dashboardConfig) {
                console.warn("Google Slides setup skipped, config not yet loaded.");
                return;
            }

            const slidesConfig = dashboardConfig; // Config is now the flat object from Firestore
            const slidesSource = slideSources.find(s => s.type === 'googleslides');

            if (!slidesConfig.googleSlides_scriptUrl || slidesConfig.googleSlides_scriptUrl.includes('PASTE') || !slidesSource) {
                console.error("Google Slides Apps Script URL is not configured in admin console or slidesSource is missing.");
                if(slidesSource) {
                    slidesSource.iframe = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl"><strong>Configuration Needed:</strong><br>Please set your Google Slides Apps Script URL in the <strong>Admin Console</strong>.</div>`;
                    slidesSource.duration = 20000;
                }
                return;
            }

            try {
                const response = await fetch(slidesConfig.googleSlides_scriptUrl, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`Failed to fetch slide count. Status: ${response.status}.`);
                
                const slideCount = parseInt(await response.text(), 10);
                if (isNaN(slideCount) || slideCount <= 0) throw new Error(`Invalid slide count received: ${slideCount}`);

                const delayMs = slidesConfig.googleSlides_delayPerSlideSeconds * 1000;
                const totalDuration = slideCount * delayMs;
                // *** NEW: Check for 0 delayMs, which causes Google Slides to use its default
                if (delayMs <= 0) {
                    console.warn("Google Slides delay is 0, duration cannot be calculated. Using default 20s.");
                    slidesSource.duration = 20000; // Fallback
                } else {
                    slidesSource.duration = totalDuration;
                }
                
                const embedUrl = `${slidesConfig.googleSlides_embedUrlBase}&delayms=${delayMs}`;
                const iframeHtml = `<iframe title="Google Slides" src="${embedUrl}" frameborder="0" class="w-full h-full"></iframe>`;

                slidesSource.iframe = iframeHtml;
                console.log(`Google Slides configured with ${slideCount} slides for a total duration of ${slidesSource.duration / 1000}s.`);

            } catch (error) {
                console.error("Error setting up Google Slides:", error);
                if(slidesSource){
                    slidesSource.iframe = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-red-400 p-8 text-center text-2xl"><strong>Error:</strong><br>Could not load Google Slides count.<br>${error.message}</div>`;
                    slidesSource.duration = 20000;
                }
            }
        }

        function scheduleNextSlide(duration) { 
            if (slideRotationTimer) clearTimeout(slideRotationTimer);
            slideRotationTimer = setTimeout(() => { 
                contentIndex = (contentIndex + 1) % slideSources.length; 
                rotateSlides(); 
            }, duration); 
        }

        function rotateSlides() {
            if (slideSources.length === 0) {
                console.warn("No slide sources available. Halting rotation.");
                return;
            }
            if (contentIndex >= slideSources.length) contentIndex = 0;

            let source = slideSources[contentIndex];
            const initialIndex = contentIndex;
            
            while (source.duration === 0) {
                console.log(`Skipping slide "${source.type || source.iframe.substring(0, 50)}" (duration is 0).`);
                contentIndex = (contentIndex + 1) % slideSources.length;
                source = slideSources[contentIndex];
                if (contentIndex === initialIndex) { 
                    console.warn("All slides have a duration of 0 or are unavailable. Halting rotation."); 
                    return; 
                }
            }

            const nextSlideIndex = 1 - activeSlideIndex;
            const currentSlide = slideDivs[activeSlideIndex];
            const nextSlide = slideDivs[nextSlideIndex];
            
            nextSlide.innerHTML = source.iframe;
            const iframe = nextSlide.querySelector('iframe');
            
            const transition = () => {
                if (nextSlide.classList.contains('opacity-100')) return;
                currentSlide.classList.remove('opacity-100');
                currentSlide.classList.add('opacity-0');
                nextSlide.classList.remove('opacity-0');
                nextSlide.classList.add('opacity-100');
                activeSlideIndex = nextSlideIndex;
                scheduleNextSlide(source.duration);
            };

            if (iframe) {
                let loaded = false;
                const loadTimeout = setTimeout(() => {
                    if (!loaded) {
                        console.warn("Iframe load timed out, transitioning anyway:", source.iframe);
                        transition();
                    }
                }, 5000); 

                iframe.onload = () => { loaded = true; clearTimeout(loadTimeout); transition(); };
                iframe.onerror = () => {
                    loaded = true; clearTimeout(loadTimeout);
                    console.error("Iframe failed to load:", source.iframe);
                    nextSlide.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-red-400 p-8 text-center text-2xl"><strong>Error:</strong><br>Could not load slide content.</div>`;
                    transition();
                };
            } else {
                transition();
            }
        }

        async function startRotation() {
            if (slideRotationTimer) clearTimeout(slideRotationTimer);
            
            // Setup Google Slides (depends on dashboardConfig)
            await setupGoogleSlides(); 
            
            if (slideSources.length === 0) {
                console.warn("No slides to display.");
                slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl">No slides configured. Please add slides in the admin console.</div>`;
                slideDivs[0].classList.remove('opacity-0');
                slideDivs[0].classList.add('opacity-100');
                return;
            }

            contentIndex = 0;
            // *** UPDATED: Find first slide with duration > 0 ***
            let firstSource = slideSources[contentIndex];
            const initialIndex = contentIndex;
            while (firstSource.duration === 0) {
                contentIndex = (contentIndex + 1) % slideSources.length;
                firstSource = slideSources[contentIndex];
                if (contentIndex === initialIndex) { 
                    console.warn("All slides have a duration of 0 or are unavailable. Halting rotation."); 
                    slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl">All slides are currently disabled (duration 0).</div>`;
                    slideDivs[0].classList.add('opacity-100');
                    return; 
                }
            }
            
            slideDivs[0].innerHTML = firstSource.iframe;
            slideDivs[1].innerHTML = '';
            slideDivs[1].classList.remove('opacity-100');
            slideDivs[1].classList.add('opacity-0');
            
            const transition = () => {
                if (slideDivs[0].classList.contains('opacity-100')) return;
                slideDivs[0].classList.remove('opacity-0');
                slideDivs[0].classList.add('opacity-100');
                activeSlideIndex = 0;
                scheduleNextSlide(firstSource.duration);
            };
            
            const firstIframe = slideDivs[0].querySelector('iframe');
            if(firstIframe) {
                let loaded = false;
                const loadTimeout = setTimeout(() => {
                    if (!loaded) {
                        console.warn("First iframe load timed out, transitioning anyway.");
                        transition();
                    }
                }, 5000);
                firstIframe.onload = () => { loaded = true; clearTimeout(loadTimeout); transition(); };
                firstIframe.onerror = () => { loaded = true; clearTimeout(loadTimeout); console.error("First iframe failed to load:", firstSource.iframe); transition(); };
            } else {
                transition();
            }
        }

        // ------------------------------
        // Remote & NWS Alert System
        // ------------------------------
        
        function showIPAWSAlert(message, duration, toneName = 'default') {
          const overlay = document.getElementById("ipawsAlertOverlay");
          overlay.innerHTML = message;
          overlay.classList.remove('invisible', 'opacity-0');
          overlay.classList.add('opacity-100');
          playAlertSound(toneName);
          setTimeout(() => {
            overlay.classList.remove('opacity-100');
            overlay.classList.add('invisible', 'opacity-0');
          }, duration);
        }

        // NEW: Active911 Alert Display
        function showActive911Alert(alertData) {
            const overlay = document.getElementById("active911AlertOverlay");
            
            // Format the alert data into HTML
            // Active911 data structure: description, call_type, address, units, notes
            const unitsString = (alertData.units || []).join(', ');
            
            // Simple formatter for address
            let address = alertData.address || 'Address not specified';
            if (alertData.city) address += `, ${alertData.city}`;

            const alertHTML = `
                <div class="w-full max-w-5xl bg-red-800 border-8 border-yellow-400 rounded-lg shadow-2xl p-8 text-left animate-pulse">
                    <h1 class="text-6xl md:text-8xl font-black text-yellow-400 mb-4">${alertData.call_type || 'NEW CALL'}</h1>
                    <p class="text-4xl md:text-5xl font-bold mb-6">${address}</p>
                    <div class="text-2xl md:text-3xl space-y-3">
                        <p><strong class="text-yellow-300 w-32 inline-block">Units:</strong> ${unitsString || 'N/A'}</p>
                        <p><strong class="text-yellow-300 w-32 inline-block">Details:</strong> ${alertData.description || 'No details'}</p>
                        ${alertData.notes ? `<p><strong class="text-yellow-300 w-32 inline-block">Notes:</strong> ${alertData.notes}</p>` : ''}
                    </div>
                </div>
            `;

            overlay.innerHTML = alertHTML;
            overlay.classList.remove('invisible', 'opacity-0');
            overlay.classList.add('opacity-100');
            playAlertSound('alarm'); // Use the 'alarm' tone for this

            const duration = (dashboardConfig.active911_alertDurationSeconds || 60) * 1000;
            
            setTimeout(() => {
                overlay.classList.remove('opacity-100');
                overlay.classList.add('invisible', 'opacity-0');
            }, duration);
        }

        async function fetchIPAWSAlerts() {
          // NEW: Guard against config not being loaded
          if (!dashboardConfig || !dashboardConfig.nwsAlertZone) {
              console.warn("IPAWS fetch skipped, config not loaded or NWS zone not set.");
              return;
          }
          try {
            const response = await fetch(`https://api.weather.gov/alerts/active/zone/${dashboardConfig.nwsAlertZone}`);
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const data = await response.json();
            const newAlertMessages = [];
            if (data.features && data.features.length > 0) {
              for (const feature of data.features) {
                const alertId = feature.id;
                if (!shownAlerts.has(alertId)) {
                  newAlertMessages.push(feature.properties.headline);
                  shownAlerts.add(alertId);
                }
              }
            }
            if (newAlertMessages.length > 0) {
              const fullMessage = newAlertMessages.join(' <span class="text-gray-500 mx-4">|||</span> ');
              const displayDuration = 60000 * newAlertMessages.length;
              showIPAWSAlert(fullMessage, displayDuration, 'alarm');
            }
          } catch (err) {
            console.error("IPAWS/NWS alert fetch failed:", err);
          }
        }

        // NEW: Active911 Alert Fetch
        async function fetchActive911Alerts() {
            if (!dashboardConfig || !dashboardConfig.active911_apiToken || !dashboardConfig.active911_departmentId) {
                console.warn("Active911 fetch skipped, config not loaded or token/ID not set.");
                return;
            }

            const token = dashboardConfig.active911_apiToken;
            const deptId = dashboardConfig.active911_departmentId;
            // Using the v2 API endpoint for recent alerts
            const apiUrl = `https://api.active911.com/api/v2/alerts/recent?token=${token}&agency_ids[]=${deptId}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    // Check for auth error
                    if (response.status === 401) {
                        console.error("Active911 API request failed: Unauthorized. Check your API Token.");
                        // Stop polling if token is bad
                        if (active911Interval) clearInterval(active911Interval);
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return;
                }
                
                const data = await response.json();

                if (data.alerts && data.alerts.length > 0) {
                    for (const alert of data.alerts) {
                        // The API filters by agency_id, but we double-check
                        if (alert.agency_id == deptId && !shownActive911Alerts.has(alert.id)) {
                            console.log("New Active911 Alert found:", alert);
                            shownActive911Alerts.add(alert.id);
                            showActive911Alert(alert);
                            
                            // If we show an alert, stop checking this batch
                            // This prevents showing multiple old alerts on first load
                            break; 
                        }
                    }
                }
            } catch (err) {
                console.error("Active911 alert fetch failed:", err);
            }
        }
        
        // ------------------------------
        // Toolbar Weather Widget
        // ------------------------------

        function getWeatherIcon(weatherCode) {
            const WMO_ICONS = {
                0: 'sun', 1: 'sun', 2: 'cloud', 3: 'cloud-drizzle', 45: 'cloud-fog', 48: 'cloud-fog',
                51: 'cloud-drizzle', 53: 'cloud-drizzle', 55: 'cloud-drizzle', 56: 'cloud-drizzle', 57: 'cloud-drizzle',
                61: 'cloud-rain', 63: 'cloud-rain', 65: 'cloud-rain', 66: 'cloud-rain', 67: 'cloud-rain',
                71: 'cloud-snow', 73: 'cloud-snow', 75: 'cloud-snow', 77: 'cloud-snow',
                80: 'cloud-rain', 81: 'cloud-rain', 82: 'cloud-rain', 85: 'cloud-snow', 86: 'cloud-snow',
                95: 'cloud-lightning', 96: 'cloud-lightning', 99: 'cloud-lightning'
            };
            return WMO_ICONS[weatherCode] || 'help-circle';
        }

        function getWeatherCondition(weatherCode) {
            const CONDITIONS = { 
                0: "Clear", 1: "Clear", 2: "Cloudy", 3: "Overcast", 45: "Fog", 48: "Fog", 
                51: "Drizzle", 53: "Drizzle", 55: "Drizzle", 56: "Freezing Drizzle", 57: "Freezing Drizzle", 
                61: "Rain", 63: "Rain", 65: "Rain", 66: "Freezing Rain", 67: "Freezing Rain", 
                71: "Snow", 73: "Snow", 75: "Snow", 77: "Snow", 80: "Showers", 81: "Showers", 82: "Showers", 
                85: "Snow Showers", 86: "Snow Showers", 95: "Thunderstorm", 96: "Thunderstorm", 99: "Thunderstorm" 
            };
            return CONDITIONS[weatherCode] || 'N/A';
        }

        async function fetchToolbarWeather() {
            // NEW: Guard against config not being loaded
            if (!dashboardConfig || !dashboardConfig.weather_latitude) {
                console.warn("Weather fetch skipped, config not loaded or latitude not set.");
                return;
            }

            const weather = dashboardConfig; // Use the loaded config
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${weather.weather_latitude}&longitude=${weather.weather_longitude}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
            
            const tempEl = document.getElementById('weather-temp');
            const conditionEl = document.getElementById('weather-condition');
            const highLowEl = document.getElementById('weather-high-low');
            const locationEl = document.getElementById('weather-location');
            const iconContainer = document.getElementById('weather-icon-container');

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Failed to fetch weather");
                const data = await response.json();
                
                const temp = Math.round(data.current.temperature_2m);
                const high = Math.round(data.daily.temperature_2m_max[0]);
                const low = Math.round(data.daily.temperature_2m_min[0]);
                const weatherCode = data.current.weather_code;
                
                const condition = getWeatherCondition(weatherCode);
                const iconName = getWeatherIcon(weatherCode);

                tempEl.textContent = `${temp}°`;
                conditionEl.textContent = condition;
                locationEl.textContent = weather.weather_locationName;
                highLowEl.textContent = `H: ${high}° L: ${low}°`;
                iconContainer.innerHTML = `<i data-feather="${iconName}" class="w-16 h-16"></i>`;
                feather.replace();

            } catch (error) {
                console.error("Toolbar weather fetch failed:", error);
                conditionEl.textContent = 'Weather unavailable';
                tempEl.textContent = '--°';
                highLowEl.textContent = 'H: --° L: --°';
                iconContainer.innerHTML = `<i data-fether="alert-triangle" class="w-16 h-16 text-yellow-400"></i>`;
                feather.replace();
            }
        }

        // ------------------------------
        // Firebase Listeners (NEW STRUCTURE)
        // ------------------------------
        
        // --- This listener starts all other listeners once config is loaded ---
        function initializeConfigListener() {
            const configDocRef = doc(db, 'config', 'global');
            
            // *** BEGIN FIX ***
            let firstConfigLoad = true; // NEW: Flag for first load
            // *** END FIX ***

            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Global config loaded/updated.");
                    dashboardConfig = docSnap.data();

                    // --- UPDATED: Load Logo URL ---
                    const logoImg = document.getElementById('dashboard-logo');
                    if (dashboardConfig.logoUrl) {
                        logoImg.src = dashboardConfig.logoUrl;
                        logoImg.style.display = 'block'; // Ensure it's visible
                    } else {
                        // If no logo is set in config, hide the element
                        logoImg.style.display = 'none';
                    }
                    // --- End of Logo Update ---

                    // Clear old intervals before setting new ones
                    if (ipawsInterval) clearInterval(ipawsInterval);
                    if (weatherInterval) clearInterval(weatherInterval);
                    if (slidesRefreshInterval) clearInterval(slidesRefreshInterval);
                    if (active911Interval) clearInterval(active911Interval); // NEW

                    // Trigger initial fetches with new config
                    fetchIPAWSAlerts();
                    fetchToolbarWeather();
                    fetchActive911Alerts(); // NEW
                    
                    // --- *** BEGIN FIX *** ---
                    if (firstConfigLoad) {
                        console.log("Attaching persistent listeners for alerts and slides.");
                        initializeAlertListener(); 
                        initializeSlideListener(); // This will call startRotation() on its own
                        firstConfigLoad = false;
                    } else {
                        // On subsequent loads (manual refresh), just restart rotation
                        console.log("Config reloaded, restarting slide rotation.");
                        // We must call startRotation() to re-run setupGoogleSlides()
                        // This will pick up new URLs or durations from the new config.
                        startRotation();
                    }
                    // --- *** END FIX *** ---

                    // Set new intervals based on loaded config
                    const ipawsRefreshMs = (dashboardConfig.nwsAlertRefreshSeconds || 300) * 1000;
                    ipawsInterval = setInterval(fetchIPAWSAlerts, ipawsRefreshMs);
                    
                    const weatherRefreshMs = Math.max(dashboardConfig.weather_refreshIntervalMinutes || 10, 1) * 60 * 1000;
                    weatherInterval = setInterval(fetchToolbarWeather, weatherRefreshMs);

                    // NEW: Active911 Interval
                    if (dashboardConfig.active911_apiToken && dashboardConfig.active911_departmentId) {
                        // Use Math.max to ensure interval is at least 10 seconds to avoid rate limiting
                        const active911RefreshMs = Math.max(dashboardConfig.active911_pollIntervalSeconds || 60, 10) * 1000;
                        active911Interval = setInterval(fetchActive911Alerts, active911RefreshMs);
                    }

                    if (dashboardConfig.googleSlides_refreshIntervalMinutes > 0) {
                        const slidesRefreshMs = dashboardConfig.googleSlides_refreshIntervalMinutes * 60 * 1000;
                        slidesRefreshInterval = setInterval(async () => {
                            console.log("Checking for Google Slides updates...");
                            await setupGoogleSlides();
                        }, slidesRefreshMs);
                    }
                } else {
                    console.error("FATAL: Global config document ('config/global') not found. Dashboard cannot function.");
                    slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-red-900 text-white p-8 text-center text-3xl"><strong>FATAL ERROR:</strong><br>Global configuration not found in database. Please set it in the admin console.</div>`;
                    slideDivs[0].classList.add('opacity-100');
                    // Also hide the logo if config fails
                    document.getElementById('dashboard-logo').style.display = 'none';
                }
            });
        }

        // --- Listens for manual alerts ---
        function initializeAlertListener() {
            const alertDocRef = doc(db, 'alerts', 'manual_alert');
            onSnapshot(alertDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Remote alert received:", docSnap.data());
                    const alertData = docSnap.data();
                    if (alertData && alertData.message && alertData.duration) {
                        let displayMessage = alertData.title ? 
                            `<div class="text-center"><h1 class="text-6xl md:text-7xl font-black mb-4">${alertData.title}</h1><p class="text-4xl md:text-5xl font-bold">${alertData.message}</p></div>` : 
                            alertData.message;
                        showIPAWSAlert(displayMessage, alertData.duration, alertData.tone || 'default');
                        setTimeout(() => deleteDoc(alertDocRef), 2000); 
                    }
                }
            }, (error) => {
                console.error("Error with Firestore alert listener: ", error);
            });
        }

        // --- Listens for slide list changes ---
        function initializeSlideListener() {
            const slidesQuery = query(collection(db, 'slides'), orderBy('order'));
            onSnapshot(slidesQuery, (snapshot) => {
                console.log("Slide configuration updated from Firestore.");
                // *** UPDATED: Always start with special slides ***
                const newSlideSources = [googleSlideSource, newsFeedSlideSource]; 
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.iframe && data.duration > 0) {
                        newSlideSources.push(data);
                    } else {
                        console.warn("Skipping invalid slide from Firestore:", doc.id, data);
                    }
                });

                // *** NEW: Sort all slides by order ***
                newSlideSources.sort((a, b) => (a.order || 99) - (b.order || 99));

                slideSources = newSlideSources; // Update the global slideSources array
                startRotation(); // Restart the slide rotation with the new data
            }, (error) => {
                console.error("Error listening to slides collection: ", error);
                // *** UPDATED: Fallback to special slides ***
                slideSources = [googleSlideSource, newsFeedSlideSource].sort((a, b) => a.order - b.order);
                startRotation();
            });
        }
        
        // ------------------------------
        // Main Initialization
        // ------------------------------
        function initializeFirebase() {
            try {
                // *** UPDATED: Changed CONFIG.firebaseConfig to firebaseConfig ***
                if (!firebaseConfig || firebaseConfig.apiKey.startsWith("PASTE_")) {
                    console.warn("Firebase is not configured. Remote features are disabled.");
                    return;
                }
                // *** UPDATED: Changed CONFIG.firebaseConfig to firebaseConfig ***
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Start by fetching config. Everything else depends on it.
                // *** UPDATED: This will now handle attaching other listeners on first load ***
                initializeConfigListener();

            } catch(e) {
                console.error("Failed to initialize Firebase listener:", e);
            }
        }

        // Start the application
        initializeFirebase();
        feather.replace(); // Initial icon render
    });
  </script>

</body>
</html>
